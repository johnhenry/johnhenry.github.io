<!DOCTYPE html><html lang="en">
  <head>
  
  <!-- { title ? <title>{title}</title> : null }

{ canonical ? (
	<link 
		rel="canonical"
		href={canonical}
	/>
) : null}

{ description ? (
	<meta
  	name="description"
  	content={description}
  />
) : null }

<meta
	name="robots"
	content={`${noindex ? 'noindex' : 'index'},${nofollow ? 'nofollow' : 'follow'}`}
> --><!-- { generateOpenGraphBasicTags(props) }
{ generateOpenGraphOptionalTags(props) }
{ generateOpenGraphImageTags(props) }
{ generateOpenGraphArticleTags(props) }
{ generateTwitterTags(props) } -->
  <meta name="theme-color" content="#343233">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <meta name="keywords" content="programming">
  <meta name="author" content="John Henry">
  
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/image/iajh.png" type="image/png">
  
<link rel="stylesheet" href="http://localhost:3001/vendor/css/reset/2.0.0/index.css"><link rel="stylesheet" href="http://localhost:3001/css/universal-unstyled-links/0.0.0/index.css"><link rel="stylesheet" href="http://localhost:3001/css/universal-box-sizing/0.0.0/index.css"><link rel="stylesheet" href="http://localhost:3001/css/universal-no-margins/0.0.0/index.css"><link rel="stylesheet" href="http://localhost:3001/css/hide-n-show/0.0.0/landscape.css">
  <link rel="stylesheet" href="/style/index.css">
  &lt;script&gt;;&lt;/script&gt;
<script type="module" src="http://localhost:3001/js/css-variables-mouse/0.0.0/index.mjs"></script><script type="module" src="http://localhost:3001/js/css-variables-scroll/0.0.0/index.mjs"></script>
  <link rel="apple-touch-icon" sizes="512x512" href="/image/iajh.512.png">
  <link rel="apple-touch-icon" sizes="384x384" href="/image/iajh.384.png">
  <link rel="apple-touch-icon" sizes="256x256" href="/image/iajh.256.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/image/iajh.192.png">
  <link rel="apple-touch-icon" sizes="128x128" href="/image/iajh.128.png">
<link rel="stylesheet" href="/assets/asset.01fdfd30.css"></link>
</head>
  <script type="module">let SITE_LIB_URL = "http://localhost:3001/";
let storageKey = "color-theme-preference";
let classes = ["color-theme-dark","","color-theme-light"];
let selector = "body";
let global = "cycleTheme";

const localStorageCycler = await import(`${SITE_LIB_URL}js/localstorage-cycler/0.0.0/index.mjs`).then(m => m.default);
  const key = `${storageKey}`;
  const values = classes;
  const target = globalThis.document.querySelector(`${selector}`);
  const emit = ({value, key, index}) => {
    target.classList.remove(...values.filter(s=>s));
    if(value){
      target.classList.add(value);
    }
  }
  globalThis[global] = localStorageCycler(key, emit, ...values);
</script>
  <script type="module">let SITE_LIB_URL = "http://localhost:3001/";
let storageKey = "mouse-chaser-preference";
let classes = ["","mouse-chaser-logo","mouse-chaser-coordinates"];
let selector = "body";
let global = "cycleMouseChaser";

const localStorageCycler = await import(`${SITE_LIB_URL}js/localstorage-cycler/0.0.0/index.mjs`).then(m => m.default);
  const key = `${storageKey}`;
  const values = classes;
  const target = globalThis.document.querySelector(`${selector}`);
  const emit = ({value, key, index}) => {
    target.classList.remove(...values.filter(s=>s));
    if(value){
      target.classList.add(value);
    }
  }
  globalThis[global] = localStorageCycler(key, emit, ...values);
</script>
  <body class="color-theme-dark">
    <header>
      <a href="/#"><img src="/image/iajh.png" width="32" height="32" alt="logo">
      <p class="hide-n-show-landscape-inline">John Henry Blog -- Browsers, Servers, and APIs</p></a>
      <nav class="hide show-landscape-flex">
        <a href="/blog">Blog</a><a href="/#me">Me</a><a href="/#projects">Projects</a>
      </nav>
    </header>
    <!-- the good stuff -->
    <section class="blog-top">
    <header><p>Browsers, Servers, and APIs</p></header>
    <a class="link-untracked" href="/blog">back to blog</a>
    <img width="360" height="210" loading="lazy" src="/vendor/img/www.pexels.com/pixabay/view-of-street-from-a-glass-window.jpg" alt="Astro">
    <article class="blog-content">
      <p class="publish-date">1 May 2019</p>
      <h1>Browsers, Servers, and APIs</h1>
      <div class="author">
        <p><a href="#">John Henry</a></p>
      </div>
      <p><em>Originally Published: <a href="https://medium.com/@iamjohnhenry/browsers-servers-and-apis-2f7b10523f39">https://medium.com/@iamjohnhenry/browsers-servers-and-apis-2f7b10523f39</a></em></p><p>(Or “The path to Isomorphic Javascript”)</p><p>Note: Examples in the article were tested and run using <a href="https://nodejs.org/en/">node</a> and <a href="http://browserify.org/">browserify</a>.</p><p>If you’re a modern JavaScript enthusiast, you’re familiar with isomorphic code — the idea that you can write code that will run in both browser and node environments. Because JavaScript is a standardized language, you might think that this would be a trivial matter. The problem comes not in the language itself, but in the <a href="https://en.wikipedia.org/wiki/Application_programming_interface">API</a>s, which are specific to each environment and not standardized to play well with others.</p><p>Some actions in one environment do not make sense in the other and so they lack specific APIs. The browser isn’t given access to the file system, so the <a href="https://nodejs.org/api/fs.html">fs object</a> that comes with node would not make sense here. Conversely, when I was younger, I would make copious use of the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/alert">window.alert</a> for debugging, but a popup window won’t show up when you’re looking at a command line.</p><p>There are some actions, however, that can be done both within node and within the browser. One of the most interesting is creating servers.</p><h2 id="standardizing-servers"><strong>Standardizing Servers</strong></h2><p>Traditionally you wouldn’t set up a server within a browser, but considering what a server does — accepts requests and responds asynchronously, we can think of many use cases.</p><p>For instance, a server within a service worker would be able to intercept and respond to requests within the browser, without ever having to make a call across a network.</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//example -- service worker</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">server</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> …;</span><span style="color: #8B949E">//define later</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    self.</span><span style="color: #D2A8FF">addEventListener</span><span style="color: #C9D1D9">(‘fetch’, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">event</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> event.</span><span style="color: #D2A8FF">respondWith</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">resolve</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">reject</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">       </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">response</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> server.</span><span style="color: #D2A8FF">respondTo</span><span style="color: #C9D1D9">(event.request);</span></span>
<span class="line"><span style="color: #C9D1D9">       response.</span><span style="color: #D2A8FF">on</span><span style="color: #C9D1D9">(“finish”, ()</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">         </span><span style="color: #D2A8FF">resolve</span><span style="color: #C9D1D9">(req);</span></span>
<span class="line"><span style="color: #C9D1D9">       });</span></span>
<span class="line"><span style="color: #C9D1D9">     }));</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span></code></pre><p>We’ll come back to this idea…</p><h2 id="competing-standards"><strong>Competing Standards</strong></h2><p>So, I want to put a server in the browser — what are my options? Not long ago, I learned about the new <a href="https://hacks.mozilla.org/2016/09/flyweb-pure-web-cross-device-interaction/">FlyWeb</a> standard that <a href="https://blog.mozilla.org/">Mozilla</a> is pushing for creating servers within the browser. I was pretty excited until i realized how different it was from anything that already existed in node.</p><p>Every other server that I’ve seen follows a particular pattern…</p><h3 id="http"><strong>HTTP</strong></h3><p>Node already has a built in simple API for creating servers via <a href="https://nodejs.org/api/http.html">http</a>.</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//example -- http</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//create server and define action</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">server</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">require</span><span style="color: #C9D1D9">(“http”)</span></span>
<span class="line"><span style="color: #C9D1D9">     .</span><span style="color: #D2A8FF">createServer</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">request</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">...</span><span style="color: #8B949E">//process request</span></span>
<span class="line"><span style="color: #C9D1D9">      response.</span><span style="color: #D2A8FF">end</span><span style="color: #C9D1D9">();</span><span style="color: #8B949E">//end response</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//start server</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">listen</span><span style="color: #C9D1D9">(</span><span style="color: #8B949E">/*listening address*/</span><span style="color: #C9D1D9">);</span></span></code></pre><p>This might be considered a standard, but many modern server applications are built to handle complex workflows.</p><h3 id="express"><strong>Express</strong></h3><p>As the http module is quite simplistic, the <a href="https://github.com/expressjs/express">express</a> module is the de-facto standard for creating servers within node. It separates creating the server from assigning it actions. It also makes handling complex workflows easier. Express servers have a “use” method. It allows the user to chain together multiple functions to act upon a request before a response is sent. These functions are called “middleware”.</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//example -- express</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//create server</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">server</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">require</span><span style="color: #C9D1D9">(“express”)();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//register middleware</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">use</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">request</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">next</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">...</span><span style="color: #8B949E">//process request</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">();</span><span style="color: #8B949E">//go to next middleware</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//register middleware</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">use</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">request</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">next</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">...</span><span style="color: #8B949E">//process request</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(request.endResponse){</span></span>
<span class="line"><span style="color: #C9D1D9">        response.</span><span style="color: #D2A8FF">end</span><span style="color: #C9D1D9">();</span><span style="color: #8B949E">//end response</span></span>
<span class="line"><span style="color: #C9D1D9">      }</span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">();</span><span style="color: #8B949E">//go to next middleware</span></span>
<span class="line"><span style="color: #C9D1D9">      }</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//register middleware</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">use</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">request</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">response</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">      response.</span><span style="color: #D2A8FF">end</span><span style="color: #C9D1D9">();</span><span style="color: #8B949E">//end response</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//start server</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">listen</span><span style="color: #C9D1D9">(</span><span style="color: #8B949E">/*listening address*/</span><span style="color: #C9D1D9">);</span></span></code></pre><p>In addition, express adds additional features such as templating or routing which you may or may not need.</p><h3 id="koa-2"><strong>Koa 2</strong></h3><p><a href="https://github.com/koajs/koa">Koa</a> was created by the same people who create express and is considered to be its spiritual successor. It’s also my server of choice, so you should <a href="http://koajs.com/">take a look at how it works</a> if you haven’t already.</p><p>Koa makes use of <a href="https://github.com/tc39/ecmascript-asyncawait">asynchronous functions</a> and adding middleware works similarly.</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//example -- koa</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">server</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">require</span><span style="color: #C9D1D9">(“koa”)();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">use</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">context</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">next</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">...</span><span style="color: #8B949E">//process request</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">();</span><span style="color: #8B949E">//go to next middleware</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">use</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">context</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">next</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">      context.res.</span><span style="color: #D2A8FF">end</span><span style="color: #C9D1D9">();</span><span style="color: #8B949E">//end response</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//start server</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">listen</span><span style="color: #C9D1D9">(</span><span style="color: #8B949E">/*listening address*/</span><span style="color: #C9D1D9">);</span></span></code></pre><p>Koa also eschews built in routing and templating in favor of including them externally as middleware.</p><p>Please be aware that Koa 2 is still in alpha, but since its API is so much cleaner than Koa 1’s, <a href="https://www.smashingmagazine.com/2016/08/getting-started-koa-2-async-functions/">here’s a tutorial that will help you jump right in</a>,</p><h3 id="rill"><strong>Rill</strong></h3><p><a href="https://github.com/rill-js/rill">Rill</a> is a <a href="https://medium.com/@pierceydylan/isomorphic-javascript-it-just-has-to-work-b9da5b0c8035#.l79bgqqwx">new server</a> that has basically the same API as KOA 2, but works in the browser as well as in node right out of the box.</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//example -- rill</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">server</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">require</span><span style="color: #C9D1D9">(“rill”)();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">use</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">context</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">next</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">      context.res.</span><span style="color: #D2A8FF">end</span><span style="color: #C9D1D9">();</span><span style="color: #8B949E">//end response</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">listen</span><span style="color: #C9D1D9">(</span><span style="color: #8B949E">/*listening address*/</span><span style="color: #C9D1D9">);</span></span></code></pre><p>Rill may be overkill for my purposes, as it includes routing features that manipulate the web page, in addition to simply processing requests into responses.</p><h3 id="flyweb"><strong>FlyWeb</strong></h3><p>There’s a basic pattern of that all of the other servers follow.</p><p>1 create server</p><p>2 add actions</p><p>3 start server</p><p>While rill or koa would have been a great starting point for a server in the browser, mozilla has taken a different route with their new FlyWeb servers.</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//example -- flyweb</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//create and start server</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">server</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> window.navigator.</span><span style="color: #D2A8FF">publishServer</span><span style="color: #C9D1D9">(</span><span style="color: #8B949E">/*listening address*/</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//add actions</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">onfetch</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">request</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">...</span><span style="color: #8B949E">//process request</span></span>
<span class="line"><span style="color: #C9D1D9">      request.</span><span style="color: #D2A8FF">end</span><span style="color: #C9D1D9">();</span><span style="color: #8B949E">//end response</span></span>
<span class="line"><span style="color: #C9D1D9">    };</span></span></code></pre><p>This breaks the pattern of everything we’ve seen so far! Here the server is created and started first. Only afterwards are actions actions added.</p><p>Do we really need an entirely new way of doing basically the same thing?</p><p><img src="https://cdn-images-1.medium.com/max/2000/1*9nMBMt-OugnruBr_M-WuEQ.png" alt="I know. It’s in every article. Perhaps that says something to the importance of the situation. https://xkcd.com/license.html"><em>I know. It’s in every article. Perhaps that says something to the importance of the situation. <a href="https://xkcd.com/license.html">https://xkcd.com/license.html</a></em></p><h2 id="rillhttp-to-the-rescue"><strong>@Rill/http to the Rescue</strong></h2><p><a href="https://medium.com/@pierceydylan/">The creators of rill are</a> pretty smart. When they created rill to work in the browser and in node, they realized the same thing I did at the beginning of this article — that dissimilar APIs are what make isomorphic code so difficult. So, to ensure that it works in both places, they created their own implementation of node’s low level <a href="https://nodejs.org/api/http.html">http module</a>, <a href="https://github.com/rill-js/http">@rill/http</a>, that works in the browser. Because it follows the same API, it can be, with a few tweaks, swapped into other modules that depend upon http, and allow them to work in the browser.</p><p>And that’s exactly what I’ve done with <a href="https://github.com/johnhenry/koa-2-browser">koa-2-browser</a>. It’s literally koa that works in the browser! It’s a light framework, so it integrates easily with other code. And because the changes are relatively minor, I’m working on landing these changes in an upcoming release of Koa as to make it an isomorphic application out of the box. For now, you can take [nearly] all code that you wrote for a koa server in node, and transfer it to the browser.</p><p>Revisiting the service worker example above, we have:</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//example -- koa-2-browser</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">server</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">require</span><span style="color: #C9D1D9">(‘koa</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">2</span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">browser’)();</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">use</span><span style="color: #C9D1D9">(</span><span style="color: #8B949E">/*middleware*/</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">listen</span><span style="color: #C9D1D9">(()</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    self.</span><span style="color: #D2A8FF">onfetch</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">event</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> event.</span><span style="color: #D2A8FF">respondWith</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">resolve</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">reject</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">          </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">response</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> server.</span><span style="color: #D2A8FF">respondTo</span><span style="color: #C9D1D9">(event.request,{browserResponse:</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">});</span></span>
<span class="line"><span style="color: #C9D1D9">          response.</span><span style="color: #D2A8FF">on</span><span style="color: #C9D1D9">(“finish”, (</span><span style="color: #FFA657">res</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">resolve</span><span style="color: #C9D1D9">(res);</span></span>
<span class="line"><span style="color: #C9D1D9">          });</span></span>
<span class="line"><span style="color: #C9D1D9">        }));</span></span>
<span class="line"><span style="color: #C9D1D9">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">/*</span></span>
<span class="line"><span style="color: #8B949E">    Note: server.RespondTo returns a response object</span></span>
<span class="line"><span style="color: #8B949E">    (here identified as &quot;response&quot;)</span></span>
<span class="line"><span style="color: #8B949E">    that is not a suitable resolution</span></span>
<span class="line"><span style="color: #8B949E">    for the promise passed to event.respond with.</span></span>
<span class="line"><span style="color: #8B949E">    Passing the &quot;browserResponse:true&quot; option</span></span>
<span class="line"><span style="color: #8B949E">    will cause the &quot;finish&quot; event to be resolved</span></span>
<span class="line"><span style="color: #8B949E">    with a suitable instance of window.Response</span></span>
<span class="line"><span style="color: #8B949E">    (identified as &quot;res&quot;).</span></span>
<span class="line"><span style="color: #8B949E">    */</span></span></code></pre><p>It’s important to realize that if we ever want to move towards isomorphic JavaScript, we should really shy away from competing standards within the language itself.</p><p>And this is true for open source software as a whole; if two different APIs do the same thing, they should have the same structure. When we set out to create something new, we should pay attention to and work with others who are already doing similar things in other environments. The less time we spend re-inventing the wheel, the more time we have to invent new and exciting stuff (hover-wheel anyone?).</p><h2 id="et-tu-buffer">Et tu, Buffer?</h2><p>Servers aren’t the only competing standards across environments.</p><p><a href="https://nodejs.org/api/buffer.html">**Buffers</a>** are standardized in node and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">**ArrayBuffers</a>** are standardized in the browser. They are both containers for binary data, but they work slightly differently. This is particularly annoying when attempting to create isomorphic applications. Even worse, some objects that have a “buffer” method, may return an ArrayBuffer instead, meaning that you may have to apply special logic to work with them in different environments.</p><p>After many revisions, <a href="https://nodejs.org/api/stream.html">**Streams</a>** are close to full standardization in node. Unfortunately, <a href="https://streams.spec.whatwg.org/">**Browser Streams</a>**, an emerging standard, introduce new and incompatible parts of the API. Hopefully, the groups involved can come to an agreement at some point.</p><p>There are some other similar topics like <strong>importing modules</strong>, but that situation is way more complicated to go into her.</p><h2 id="bonus-library">Bonus Library!!!</h2><p>But trying new things is fun! I actually prefer the <a href="https://github.com/flyweb/spec">way that FlyWeb creates servers</a>. Since it <a href="https://github.com/koajs/koa/issues/482">it appears that I’m not the only one</a>, I’ve created another library, <a href="https://github.com/johnhenry/flyweb-koa">flyweb-koa</a>. It allows you to use koa in a manner similar to the FlyWeb, while maintaining everything that koa has to offer.</p><pre class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">koa</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">require</span><span style="color: #C9D1D9">(“koa</span><span style="color: #FF7B72">-</span><span style="color: #79C0FF">2</span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">browser”);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">//This also works with koa;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">publishServer</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">require</span><span style="color: #C9D1D9">(‘flyweb</span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9">koa’)(‘koa’);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">server</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">publishServer</span><span style="color: #C9D1D9">(</span><span style="color: #8B949E">/*listening address*/</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">use</span><span style="color: #C9D1D9">(</span><span style="color: #8B949E">/*middleware*/</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">onfetch</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">context</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">...</span></span>
<span class="line"><span style="color: #C9D1D9">    };</span></span>
<span class="line"><span style="color: #C9D1D9">    server.</span><span style="color: #D2A8FF">respondTo</span><span style="color: #C9D1D9">(</span><span style="color: #8B949E">/*request*/</span><span style="color: #C9D1D9">);</span></span></code></pre>
    </article>
    <a class="link-untracked" href="/blog">back to blog</a>
  </section>
    <!-- the good stuff -->
    <span class="mouse-chaser"></span>
    <footer>
    <a href="#">© 2022   John Henry</a>
      <!-- Todo: Astro whitespace may be fixed in Astro 0.21? -->
      <nav>
        <a href="#" class="mouse-chaser-toggler" onclick="event.preventDefault(),window.cycleMouseChaser()" title="Click to toggle mouse."></a>
        <a href="#" class="color-theme-toggler" onclick="event.preventDefault(),window.cycleTheme()" title="Click to toggle color theme."></a>
      </nav>
    </footer>
    
    
  </body>
</html>